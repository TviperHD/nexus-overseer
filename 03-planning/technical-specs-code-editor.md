# Technical Specification: Code Editor Integration

**Date:** 2024-12-28  
**Status:** Planning  
**Version:** 1.0

## Overview

The Code Editor Integration System provides Monaco Editor integration for Nexus Overseer, enabling users to view and edit code files within the application. Each open file appears as a tab in the main tab system (not internal file tabs). The system handles file loading, syntax highlighting, code editing, and integration with the file system and Implementation AI.

**Key Features:**
- Monaco Editor integration (VS Code's editor)
- Files as tabs in main tab system (each file is its own tab)
- Syntax highlighting for multiple languages
- Code editing operations
- File watching and auto-reload
- Integration with file system
- Integration with Implementation AI
- Single file view per tab (no internal file tabs)

**Purpose:**
- Display code files to users
- Allow manual code editing
- Show code generated by Implementation AI
- Provide familiar code editing experience
- Support multiple open files (as tabs in main tab system)

---

## System Architecture

### High-Level Design

The Code Editor Integration System consists of:

1. **Monaco Editor Component:** Main editor component (shows single file)
2. **File Tab Integration:** Files appear as tabs in main tab system
3. **Editor State Manager:** Manages editor state (cursor, scroll, etc.)
4. **File Integration:** Integrates with file system
5. **Syntax Configuration:** Language and syntax configuration
6. **Tab System Integration:** Works with main tab system for file management

### Component Hierarchy

```
CodeEditorIntegration (Main Module)
├── MonacoEditor (Editor Component)
│   ├── EditorInstance (Monaco editor instance)
│   ├── LanguageService (Syntax highlighting)
│   └── EditorOptions (Configuration)
├── EditorStateManager (State Management)
│   ├── OpenFiles (Open files state - tracked in main tab system)
│   ├── ActiveFile (Currently active file - from active tab)
│   ├── EditorViewState (Cursor, scroll, selections)
│   └── EditorSettings (Editor preferences)
├── FileIntegration (File System)
│   ├── FileLoader (Load files)
│   ├── FileSaver (Save files)
│   └── FileWatcher (Watch file changes)
└── TabSystemIntegration (Main Tab System)
    ├── FileTabCreation (Creates file tabs in main tab system)
    ├── FileTabUpdates (Updates file tab state)
    └── FileTabRemoval (Removes file tabs)
```

### Data Flow

```
User Opens File
  ↓
Tab System (Creates file tab in main tab system)
  ↓
File System (Reads file)
  ↓
Monaco Editor (Loads content into editor panel)
  ↓
File Tab Shows in Main Tab Bar
  ↓
User Edits Code
  ↓
Editor State (Tracks changes)
  ↓
File Tab Shows Modified Indicator (*)
  ↓
User Saves
  ↓
File System (Writes file)
  ↓
File Tab Modified Indicator Removed
  ↓
File Watcher (Detects change)
  ↓
Editor (Updates if needed)
```

---

## Data Structures

### Frontend (TypeScript)

**Open File:**
```typescript
interface OpenFile {
  id: string;                    // UUID
  path: string;                  // File path
  name: string;                  // File name
  content: string;               // File content
  language: string;               // Language ID (typescript, rust, etc.)
  isModified: boolean;            // Has unsaved changes
  isReadOnly: boolean;            // Read-only file
  encoding: string;               // File encoding (utf-8, etc.)
  lineCount: number;              // Number of lines
  lastModified: string;           // Last modified timestamp
}
```

**Editor State:**
```typescript
interface EditorState {
  openFiles: OpenFile[];
  activeFileId: string | null;
  editorSettings: EditorSettings;
  viewState: EditorViewState;    // Cursor position, scroll, etc.
}

interface EditorSettings {
  theme: string;                 // Editor theme
  fontSize: number;               // Font size
  wordWrap: 'on' | 'off' | 'wordWrapColumn' | 'bounded';
  minimap: { enabled: boolean };
  lineNumbers: 'on' | 'off' | 'relative';
  tabSize: number;
  insertSpaces: boolean;
}
```

**Editor View State:**
```typescript
interface EditorViewState {
  cursorPosition: { line: number; column: number };
  scrollPosition: { scrollTop: number; scrollLeft: number };
  selections: Selection[];
  foldingRanges: FoldingRange[];
}
```

### Backend (Rust)

**Editor-related data structures are minimal - most state is frontend-only. Backend provides:**
- File read/write operations (via File System Integration)
- File watching (via File System Integration)
- File metadata (via File System Integration)

---

## Core Components

### Frontend Components

#### MonacoEditor.tsx

**Purpose:** Main Monaco Editor component wrapper.

**Props:**
- `file: OpenFile` - Current file to display
- `onChange: (content: string) => void` - Content change handler
- `onSave: () => void` - Save handler
- `readOnly?: boolean` - Read-only mode
- `theme?: string` - Editor theme

**Features:**
- Monaco Editor instance management
- Language detection and configuration
- Syntax highlighting
- Code completion (IntelliSense)
- Error markers
- Code formatting

**Implementation:**
```typescript
import Editor from '@monaco-editor/react';

function MonacoEditor({ file, onChange, onSave, readOnly, theme }) {
  const handleEditorChange = (value: string | undefined) => {
    if (value !== undefined) {
      onChange(value);
    }
  };

  return (
    <Editor
      height="100%"
      language={file.language}
      value={file.content}
      onChange={handleEditorChange}
      theme={theme || 'vs-dark'}
      options={{
        readOnly,
        fontSize: 14,
        minimap: { enabled: true },
        wordWrap: 'on',
        // ... other options
      }}
    />
  );
}
```

#### FileTabIntegration.ts

**Purpose:** Integrates file management with main tab system.

**Features:**
- Creates file tabs in main tab system when files are opened
- Updates file tab state (modified indicator, etc.)
- Removes file tabs when files are closed
- Tracks which files are open (via tab system)
- Manages file-to-tab mapping

#### EditorStore (Zustand)

**Purpose:** Global state management for editor.

**State:**
```typescript
interface EditorStore {
  // File state (tracked via tab system)
  fileToTabMap: Map<string, string>; // File path -> Tab ID
  tabToFileMap: Map<string, string>; // Tab ID -> File path
  fileContent: Map<string, string>; // File path -> content
  fileViewState: Map<string, EditorViewState>; // File path -> view state
  
  // Editor state
  activeFileId: string | null; // Currently active file (from active tab)
  editorSettings: EditorSettings;
  
  // Actions
  openFile: (path: string) => Promise<void>; // Creates tab in main tab system
  closeFile: (fileId: string) => void; // Removes tab from main tab system
  setActiveFile: (fileId: string) => void; // Sets active tab in tab system
  updateFileContent: (fileId: string, content: string) => void; // Updates content, marks tab as modified
  saveFile: (fileId: string) => Promise<void>;
  saveAllFiles: () => Promise<void>;
  reloadFile: (fileId: string) => Promise<void>;
  getFileFromTab: (tabId: string) => string | null; // Get file path from tab ID
  getTabFromFile: (filePath: string) => string | null; // Get tab ID from file path
}
```

### Backend Integration

**Tauri Commands Used:**
- `read_file(path)` - Read file content (from File System Integration)
- `write_file(request)` - Write file content (from File System Integration)
- `watch_file(path)` - Watch file for changes (from File System Integration)
- `get_file_metadata(path)` - Get file metadata (from File System Integration)

---

## Algorithms

### File Open Flow

1. User requests to open file (click in file tree, command, etc.)
2. Check if file is already open (check tab system)
3. If not open:
   - Call `read_file()` via Tauri
   - Detect language from file extension
   - Create file tab in main tab system
   - Add file-to-tab mapping
   - Load content into editor state
4. Set file tab as active in tab system
5. Load content into Monaco Editor (editor panel shows active file)
6. Start watching file for external changes
7. File tab appears in main tab bar

### File Save Flow

1. User saves file (Ctrl+S, menu, etc.)
2. Get current file content from editor
3. Call `write_file()` via Tauri
4. Update file's `isModified` flag to false
5. Update file's `lastModified` timestamp
6. Show save confirmation

### File Close Flow

1. User closes file tab (clicks × on tab in main tab bar)
2. Check if file has unsaved changes
3. If modified:
   - Show confirmation dialog
   - If user cancels, abort close
   - If user confirms, proceed
4. Stop watching file
5. Remove file tab from main tab system
6. Remove file-to-tab mapping
7. Clear file content from editor state
8. If was active file, switch to another tab (could be another file or panel)

### File Watch Flow

1. File watcher detects external change
2. Check if file is open in editor
3. If open:
   - Compare file content with editor content
   - If different:
     - Check if editor has unsaved changes
     - If editor has changes, show conflict dialog
     - If no editor changes, reload file automatically
4. Update editor content if reloaded

### Language Detection Flow

1. Get file extension
2. Map extension to Monaco language ID
3. Configure Monaco for that language
4. Enable language-specific features (IntelliSense, etc.)

---

## Integration Points

### With File System Integration

**File Operations:**
- Uses file system module to read/write files
- Uses file watcher to detect external changes
- Handles file system errors gracefully

### With Implementation AI

**Code Display:**
- Implementation AI writes code to files
- File watcher detects change
- Editor automatically reloads file
- User sees generated code immediately

**Code Editing:**
- User can edit AI-generated code
- Changes tracked in editor state
- User can save modified code

### With Project Management

**Project Context:**
- Editor knows current project
- File paths relative to project root
- Project settings affect editor behavior

### With UI Components

**Editor Panel:**
- Editor is a resizable panel
- Can be detached to separate window
- Integrates with panel system

---

## Monaco Editor Configuration

### Language Support

**Supported Languages:**
- TypeScript/JavaScript
- Rust
- Python
- Markdown
- JSON
- YAML
- And many more (Monaco supports 100+ languages)

### Editor Options

**Default Configuration:**
```typescript
{
  theme: 'vs-dark',
  fontSize: 14,
  fontFamily: 'Consolas, "Courier New", monospace',
  wordWrap: 'on',
  minimap: { enabled: true },
  lineNumbers: 'on',
  renderWhitespace: 'selection',
  tabSize: 2,
  insertSpaces: true,
  automaticLayout: true,
  scrollBeyondLastLine: false,
  formatOnPaste: true,
  formatOnType: true,
}
```

### IntelliSense Configuration

**Code Completion:**
- Enable for supported languages
- TypeScript/JavaScript: Full IntelliSense
- Other languages: Basic completion
- Custom snippets support

---

## Performance Considerations

### Large Files

1. **Virtual Scrolling:** Monaco handles large files efficiently
2. **Lazy Loading:** Load file content on demand
3. **File Size Limits:** Warn or prevent opening very large files
4. **Incremental Updates:** Only update changed parts

### Multiple Open Files

1. **Lazy Loading:** Only load active file content initially
2. **Memory Management:** Unload inactive files if needed
3. **Tab Management:** Limit number of open files
4. **Efficient State:** Minimize state updates

### Editor Performance

1. **Debouncing:** Debounce content change events
2. **Selective Updates:** Only update what changed
3. **Monaco Optimization:** Use Monaco's built-in optimizations

---

## Security Considerations

1. **File Access:** All file access goes through security validation
2. **Path Validation:** Validate all file paths
3. **Content Validation:** Validate file content before saving
4. **Error Handling:** Don't expose file paths in errors

---

## Error Handling

### Error Types

1. **File Not Found:** File doesn't exist
2. **Permission Denied:** No permission to read/write
3. **Encoding Error:** File encoding not supported
4. **File Too Large:** File exceeds size limit
5. **Save Error:** Failed to save file

### Error Handling Strategy

1. **User Feedback:** Show user-friendly error messages
2. **Recovery:** Attempt to recover from errors
3. **Logging:** Log technical details for debugging
4. **Graceful Degradation:** Continue with reduced functionality if possible

---

## Testing Checklist

### Unit Tests

- [ ] File opening
- [ ] File saving
- [ ] File closing
- [ ] Tab management
- [ ] Language detection
- [ ] Editor state management
- [ ] Error handling

### Integration Tests

- [ ] File system integration
- [ ] File watching
- [ ] Implementation AI integration
- [ ] Multiple file handling
- [ ] Unsaved changes handling

### User Acceptance Tests

- [ ] User can open files
- [ ] User can edit code
- [ ] User can save files
- [ ] Syntax highlighting works
- [ ] File tabs work correctly
- [ ] External file changes detected
- [ ] Unsaved changes warning works
- [ ] Performance is acceptable

---

## Research Notes

### Monaco Editor Integration

**Research Findings:**
- Monaco Editor is well-documented and widely used
- React integration via `@monaco-editor/react` package
- Supports 100+ programming languages
- Full IntelliSense support for TypeScript/JavaScript
- Highly configurable and customizable

**Sources:**
- [Monaco Editor GitHub](https://github.com/microsoft/monaco-editor)
- [Monaco Editor React Package](https://www.npmjs.com/package/@monaco-editor/react)
- Monaco Editor documentation

**Implementation Approach:**
- Use `@monaco-editor/react` for React integration
- Configure editor options for good UX
- Handle file operations via Tauri commands
- Use file watcher for external changes

**Why This Approach:**
- Standard React integration
- Well-maintained package
- Full-featured editor
- Familiar to users (VS Code editor)

### File Tab Management

**Research Findings:**
- File tabs are standard in code editors
- Show modified indicator (*) for unsaved changes
- Handle unsaved changes on close
- Support keyboard shortcuts (Ctrl+Tab, etc.)

**Sources:**
- VS Code file tab implementation
- General code editor patterns

**Implementation Approach:**
- Track open files in state
- Show tabs with file names
- Indicate modified files with *
- Handle close with unsaved changes warning
- Support keyboard shortcuts

**Why This Approach:**
- Familiar UX pattern
- Standard code editor behavior
- Good user experience
- Easy to implement

### File Watching Integration

**Research Findings:**
- File watching enables real-time updates
- Need to handle conflicts (external changes vs. editor changes)
- Should auto-reload if no editor changes
- Should warn if editor has unsaved changes

**Sources:**
- File watching patterns
- Code editor file watching implementations

**Implementation Approach:**
- Use file system file watcher
- Compare file content with editor content
- Auto-reload if no conflicts
- Show conflict dialog if editor has changes

**Why This Approach:**
- Real-time updates improve UX
- Conflict handling prevents data loss
- Standard pattern for code editors
- User-friendly

---

## Next Steps

1. ✅ Create specification (this document)
2. ⏳ Install Monaco Editor React package
3. ⏳ Implement Monaco Editor component
4. ⏳ Implement file tab manager
5. ⏳ Implement editor state management
6. ⏳ Integrate with file system
7. ⏳ Integrate with file watcher
8. ⏳ Add keyboard shortcuts
9. ⏳ Testing and refinement

---

## Notes

- Monaco Editor is the core of the code editing experience
- File tab management is important for multi-file editing
- File watching enables real-time updates
- Integration with Implementation AI is key feature
- Performance is important for large files
- User experience should match familiar code editors

